<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
  <meta charset="UTF-8">
  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
  <script th:src="@{/js/login.js}"></script>
</head>
<body>

<div th:replace="~{fragments/header :: header}"/>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <h3>그룹 생성</h3>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4">
    </div>
    <div class="col-md-4">
      <form role="form" th:method="POST" th:object="${groupMakeRequest}">
        <div class="form-group">
          <label th:for="name">
            그룹 이름
          </label>
          <input type="text" class="form-control" th:field="*{name}"
                 placeholder="그룹 이름을 입력하세요"/>
        </div>
        <div class="form-group">
          <label th:for="roleInGroup">
            그룹 이름
          </label>
          <input type="text" class="form-control" th:field="*{roleInGroup}"
                 placeholder="닉네임을 입력하세요"/>
        </div>

        <br>
        <button type="button" class="btn btn-primary" onclick="group_join()">
          생성 완료
        </button>
      </form>
      <br>
    </div>
    <div class="col-md-4">
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
    </div>
  </div>
</div>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="text/javascript" th:src="@{/js/sign.js}"></script>
<script th:inline="javascript">

  axios.interceptors.request.use(function (config) {
    console.log("인터셉터 시작")
    const accessToken = localStorage.getItem('accessToken');
    if (accessToken) {
      config.headers.Authorization = 'Bearer' + ' ' + accessToken
    } else {
      console.log("headers" + config.headers);
    }
    return config;
  })

   axios.interceptors.response.use(
       success => success,
       async (error) => {
         console.log("인터셉터 에러" + error);
         const status = error.response.status

         if (status === 401) {
           const originRequest = error.config;
           const cookie = document.cookie;
           console.log("내가 만든 쿠키" + cookie)
           await axios.post('/api/v1/users/new-token',
               {
                 "Content-Type": `application/json`,
                 accessToken: "Bearer " + localStorage.getItem("accessToken"),
                 refreshToken: cookie
               })
           .then(response => {
             console.log("인터셉터 리스폰스 데이터" + response.data);
             localStorage.setItem("accessToken", response.data);
           })
           .catch(error => {
             console.log('fail');
             localStorage.removeItem('accessToken')
           })
           return Promise.reject(error)
         }
       }
   )

  axios.defaults.withCredentials = true;

  async function group_join() {
    let name = $("#name").val();
    let roleInGroup = $("#roleInGroup").val();
    const token = localStorage.getItem("accessToken")
    const cookie = document.cookie;

    console.log("쿠키" + cookie);

    await axios.post("/api/v1/groups", {
      "name": name,
      "roleInGroup": roleInGroup
    }, {
      headers: {
        "Content-Type": `application/json`,
        Authorization: "Bearer " + localStorage.getItem("accessToken")
      },
    }).then(res => {
      console.log(res)
      if (res.data.resultCode == 'SUCCESS') {
        console.log("바로 실행 로그");
        console.log(res.data.resultCode);
        console.log(res.data.result.id);

        sessionStorage.setItem("groupId", res.data.result.id);
        document.location.href = "/view/pets"
      } else {
        console.log("실패임" + res.resultCode)
      }
    });
  }




</script>
</body>
</html>
