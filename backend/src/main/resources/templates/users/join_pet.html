<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">

  <!-- Bootstrap 5.2.3 Version -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">


  <!-- Datepicker 생일 클릭시 달력 이벤트 -->
  <link rel="stylesheet" th:href="@{//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css}">
  <link rel="stylesheet" th:href="@{/resources/demos/style.css}">
  <script th:src="@{https://code.jquery.com/jquery-3.6.0.js}"></script>
  <script th:src="@{https://code.jquery.com/ui/1.13.2/jquery-ui.js}"></script>
  <script>

    $(function () {
      $("#birthday").datepicker({dateFormat: 'yy-mm-dd'});
    });
  </script>

  <title>개묘한 이야기</title>
</head>
<body>

<div th:replace="~{fragments/header :: header}"/>


<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <h3>반려동물 등록</h3>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4">
    </div>
    <div class="col-md-4">
      <form role="form" th:method="POST" th:object="${petAddRequest}">
        <div class="form-group">

          <label th:for="species">
            종
          </label>
          <br>
          <label><input type="radio" name="species" th:field="*{species}" value="DOG"> 강아지</label>
          <label><input type="radio" name="species" th:field="*{species}" value="CAT"> 고양이</label>
        </div>

        <div class="form-group">

          <label th:for="breed">
            품종
          </label>
          <input type="text" class="form-control" th:field="*{breed}"/>
        </div>

        <div class="form-group">

          <label th:for="name">
            이름
          </label>
          <input type="text" class="form-control" th:field="*{name}"/>
        </div>

        <div class="form-group">

          <label th:for="birthday">
            생일
          </label>
          <input type="text" class="form-control" th:field="*{birthday}"/>
        </div>

        <div class="form-group">

          <label th:for="sex">
            성별
          </label>
          <br>
          <label><input type="radio" name="sex" th:field="*{sex}" value="FEMALE"> 암컷</label>
          <label><input type="radio" name="sex" th:field="*{sex}" value="MALE"> 수컷</label>
          <label><input type="radio" name="sex" th:field="*{sex}" value="SPAYED_FEMALE"> 중성화
            암컷</label>
          <label><input type="radio" name="sex" th:field="*{sex}" value="NEUTERED_MALE"> 중성화
            수컷</label>
        </div>

        <div class="form-group">

          <label th:for="weight">
            몸무게
          </label>
          <input type="text" class="form-control" th:field="*{weight}"/>
        </div>


        <br>
        <button type="button" class="btn btn-primary" onclick="pet_create()">
          작성 완료
        </button>
      </form>


    </div>
    <div class="col-md-4">
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
    </div>
  </div>
</div>
<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">

  axios.defaults.withCredentials = true;

  async function pet_create() {
    let groupId = sessionStorage.getItem("groupId");
    console.log(sessionStorage.getItem("groupId"));

    let name = $("#name").val();
    let species = $("input:radio[name=species]:checked").val();
    let breed = $("#breed").val();
    let sex = $("input:radio[name=sex]:checked").val();
    let birthday = $("#birthday").val();
    let weight = $("#weight").val();

    console.log(birthday)
    await axios.post(`/api/v1/groups/${groupId}/pets`, {
      "name": name,
      "species": species,
      "breed": breed,
      "sex": sex,
      "birthday": birthday,
      "weight": weight
    }, {
      headers: {
        "Content-Type": `application/json`,
        Authorization: "Bearer " + localStorage.getItem("accessToken")
      },
    }).then(res => {
      console.log(res)
      if (res.data.resultCode == 'SUCCESS') {
        console.log("바로 실행 로그");
        console.log(res.data.resultCode);
        console.log(res.data.result.id);

        document.location.href = "/view/calendar"
      } else {
        console.log("실패임" + res.resultCode)
      }
    });

  }
  axios.interceptors.request.use(function (config) {
    console.log("인터셉터 시작")
    const accessToken = localStorage.getItem('accessToken');
    const cookie = document.cookie;
    console.log("헤더" + config.headers);
    console.log("cookie" + cookie);
    if (accessToken) {
      config.headers.Authorization = `Bearer ${accessToken}`;
    }
    return config;
  })

  // axios.interceptors.request.use(function (config) {
  //   console.log("인터셉터 시작")
  //   const accessToken = localStorage.getItem('accessToken');
  //   if (accessToken) {
  //     config.headers.Authorization = `Bearer ${accessToken}`;
  //   }
  //   return config;
  // })
  //
  // axios.interceptors.response.use(
  //     success => success,
  //     async (error) => {
  //       console.log("인터셉터 에러" + error);
  //       const status = error.response.status
  //
  //       if (status === 401) {
  //         await axios.post('/api/v1/users/new-token', {}, {
  //           headers: {
  //             "Content-Type": `application/json`,
  //             Authorization: "Bearer " + localStorage.getItem("accessToken")
  //           },
  //         })
  //         .then(response => {
  //           console.log("인터셉터 리스폰스 데이터" + response.data.result.accessToken);
  //           localStorage.setItem("accessToken", response.data.result.accessToken);
  //         })
  //         .catch(error => {
  //           console.log('fail' + error);
  //           localStorage.removeItem('accessToken')
  //         })
  //         return Promise.reject(error)
  //       }
  //     }
  // )

</script>
</body>
</html>
