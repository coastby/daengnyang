<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>DAENG NYANG</title>
  <!-- Bootstrap 5.2.3 Version -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script th:src="@{/fullcalendar-6.0.3/dist/index.global.js}"></script>

  <script>
    make_calendar();
    var rct_date;

    function make_calendar() {
      document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          header: {
            left: '',
            center: 'title',
            right: 'today prev,next'
          },
          events: function (fetchInfo, successCallback, failureCallback) {
            var start = fetchInfo.start;
            var end = fetchInfo.end;

            var fromDate = date_to_yyyymmdd(start);
            var toDate = date_to_yyyymmdd(end);

            const param = "?fromDate=" + fromDate + "&toDate=" + toDate;
            axios.get("/api/v1/pets/" + petId + "/monitorings" + param, {}, {
              headers: {},
            }).then(res => {
              if (res.data.resultCode == 'SUCCESS') {
                monitorings = res.data.result.monthlyMonitorings;
                const dates = monitorings.map(mnt => mnt['date']);
                var events = dates.map(date => to_map(date));

                successCallback(events);
              } else {
                console.log("실패임" + res.resultCode)
              }
            });
          },
          eventClick: function (info) {
            console.log(info);
            rct_date = info.dateStr;
            $("#createModal").modal("show");
          },
          dateClick: function (info) {
            rct_date = info.dateStr;
            $("#createModal").modal("show");
          }
        });
        calendar.render();
      });
    }
  </script>
  <style>
    a {
      text-decoration: none;
      color: inherit;
    }

    #createModal label {
      font-weight: bolder;
    }
  </style>

</head>

<body>
<div th:replace="~{fragments/header :: header}"/>

<!--header----------------------------->


<!--calendar-->

<div class="container-fluid">
  <div class="row">
    <div id="calendar" style="width: 80%; margin: auto;"></div>
  </div>
</div>


<!--create modal-->

<div class="modal fade" id="createModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">모니터링 등록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">

          <input type="checkbox" class="form-check-input" id="vomit" value="vomit">
          <label class="form-check-label" for="vomit">구토</label>
          <input type="checkbox" class="form-check-input" id="amPill" value="amPill"
                 style="margin-left: 10px">
          <label class="form-check-label" for="amPill">아침약</label>
          <input type="checkbox" class="form-check-input" id="pmPill" value="pmPill"
                 style="margin-left: 10px">
          <label class="form-check-label" for="pmPill">저녁약</label>
          <!--          custom-check-->
          <div class="input-group mb-3 mt-3">
            <div class="input-group-text">
              <input class="form-check-input mt-0" type="checkbox" id="customSymptom"
                     value="customSymptom" aria-label="Checkbox for following text input">
            </div>
            <input type="text" id="customSymptomName" class="form-control"
                   aria-label="Text input with checkbox" placeholder="사용자 지정 항목">
          </div>

          <div class="row g-3 align-items-center mt-2">
            <div class="col-3">
              <label for="weight" class="col-form-label">몸무게</label>
            </div>
            <div class="col-auto">
              <input type="number" id="weight" class="form-control" min="0" step="0.1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="feedToGram" class="col-form-label">식이량 (g)</label>
            </div>
            <div class="col-auto">
              <input type="number" id="feedToGram" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="walkCnt" class="col-form-label">산책 횟수</label>
            </div>
            <div class="col-auto">
              <input type="number" id="walkCnt" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="playCnt" class="col-form-label">놀이 횟수</label>
            </div>
            <div class="col-auto">
              <input type="number" id="playCnt" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="urination" class="col-form-label">배뇨</label>
            </div>
            <div class="col-auto">
              <input type="number" id="urination" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="defecation" class="col-form-label">배변</label>
            </div>
            <div class="col-auto">
              <input type="number" id="defecation" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <div class="row g-3 align-items-center mt-1">
            <div class="col-3">
              <label for="respiratoryRate" class="col-form-label">호흡수</label>
            </div>
            <div class="col-auto">
              <input type="number" id="respiratoryRate" class="form-control" min="0" step="1">
            </div>
            <div class="col-auto">
            </div>
          </div>

          <label class="col-form-label mt-2">사용자 지정 항목</label>
          <div class="input-group mb-3 mt-1">
            <input type="text" id="customIntName" class="form-control" placeholder="항목 이름">
            <input type="number" id="customInt" min="0" step="1" class="form-control" style="width: 40%;"
                   placeholder="횟수">
          </div>

          <div class="mb-3">
            <label for="notes" class="form-label">특이 사항</label>
            <textarea class="form-control" id="notes" rows="3"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="addMonitoring"
                onclick="save_monitoring()">
          추가
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!--show modal-->

<div class="modal fade" id="showModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="show-title">2023-01-01</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="modifyMonitoring">
          수정
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>


<!--footer---------------------------->

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
  const petId = [[${petId}]];
  let monitorings;

  axios.defaults.withCredentials = true;

  function date_to_yyyymmdd(date) {
    const year = String(date.getFullYear());
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    return year + month.padStart(2, '0') + day.padStart(2, '0');
  }

  function to_map(date) {
    var result =
        {
          title: '작성 완료',
          start: date
        };
    return result;
  }

  // -----------------save monitoring
  async function save_monitoring() {
    let date = rct_date;
    let weight = $("#weight").val();

    let vomit = $("#vomit").is(':checked');
    let amPill = $("#amPill").is(':checked');
    let pmPill = $("#pmPill").is(':checked');
    let customSymptom = $("#customSymptom").is(':checked');
    let customSymptomName = $("#customSymptomName").val();

    let feedToGram = $("#feedToGram").val();
    let walkCnt = $("#walkCnt").val();
    let playCnt = $("#playCnt").val();
    let urination = $("#urination").val();
    let defecation = $("#defecation").val();
    let respiratoryRate = $("#respiratoryRate").val();
    let customInt = $("#customInt").val();
    let customIntName = $("#customIntName").val();

    let notes = $("#notes").val();

    let params = {
      "date": date,
      "weight": weight,

      "vomit": vomit,
      "amPill": amPill,
      "pmPill": pmPill,
      "customSymptom": customSymptom,
      "customSymptomName": customSymptomName,

      "feedToGram": feedToGram,
      "walkCnt": walkCnt,
      "playCnt": playCnt,
      "urination": urination,
      "defecation": defecation,
      "respiratoryRate": respiratoryRate,
      "customInt": customInt,
      "customIntName": customIntName,

      "notes": notes
    };
    console.log(params.toString());

    await axios.post("/api/v1/pets/" + petId + "/monitorings", params, {}
    ).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        console.log(res.data.result);
        document.location.href = "/view/pets/" + petId + "/monitorings";
      } else {
        console.log("실패임" + res.resultCode)
      }
    });
  }

  axios.interceptors.request.use(function (config) {
    console.log("인터셉터 시작")
    const accessToken = localStorage.getItem('accessToken');
    if (accessToken) {
      config.headers.Authorization = 'Bearer' + ' ' + accessToken
    } else {
      console.log("headers" + config.headers);
    }
    return config;
  })

</script>
</body>
</html>