<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>DAENG NYANG</title>
  <!-- 화면 해상도에 따라 글자 크기 대응(모바일 대응) -->
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <!-- Bootstrap 5.2.3 Version -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

  <!-- CSS -->
  <link th:href="@{/css/styles.css}" rel="stylesheet"/>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script type="text/javascript" th:src="@{/js/sign.js}"></script>
  <script th:src="@{/fullcalendar-6.0.3/dist/index.global.js}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: '2023-02-15',
        eventAdd: function (obj) { // 이벤트가 추가되면 발생하는 이벤트
          console.log(obj);
        },
        eventChange: function (obj) { // 이벤트가 수정되면 발생하는 이벤트
          console.log(obj);
        },
        eventRemove: function (obj) { // 이벤트가 삭제되면 발생하는 이벤트
          console.log(obj);
        },
        select: function (arg) { // 캘린더에서 드래그로 이벤트를 생성할 수 있다.
          var title = prompt('Event Title:');
          if (title) {
            calendar.addEvent({
              title: title,
              start: arg.start,
              end: arg.end,
              allDay: arg.allDay
            })
          }
          calendar.unselect()
        },
        // 이벤트
        events: function (fetchInfo, successCallback, failureCallback) {
          var start = fetchInfo.start;
          var end = fetchInfo.end;

          var fromDate = date_to_yyyymmdd(start);
          var toDate = date_to_yyyymmdd(end);
          const param = "?fromDate=" + fromDate + "&toDate=" + toDate;
          getContents(param, successCallback);
        }
        ,
        dateClick: function (info) {
          $("#calendarModal").modal("show");
        }
      });
      calendar.render();
    });
  </script>
  <style>
    #sidebar {
      width: 320px;
      position: fixed;
      top: 56px;
      left: 0px;
      height: calc(100% - 56px);
      z-index: 999;
      background: #333;
      color: #fff;
      transition: all 0.3s;
    }

    #contents-wrapper {
      width: calc(100% - 320px);
      float: right;
    }
  </style>
</head>
<body>

<div th:insert="~{fragments/header :: header}"></div>
<div class="col-md-12 text-center mb-5">
  <h1>그룹 이름</h1>
</div>
<div id="wrap">
  <nav id="sidebar" class="active" style="overflow-y: scroll;">
    <div style="padding: 20px">
      <h6 class="mb-2">필터</h6>
      <div class="my-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="ongoing-filter">
          <label class="form-check-label" for="ongoing-filter">치료 중만 보기</label>
        </div>
      </div>

      <h6 class="mb-2">선택</h6>
      <div class="my-3">
        <div class="form-check form-check-inline">
          <input class="form-check-input sort-inp" type="checkbox" name="contentsType"
                 id="record-check"
                 value="record" checked>
          <label class="form-check-label" for="record-check">일기</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input sort-inp" type="checkbox" name="contentsType"
                 id="schedule-check"
                 value="schedule" checked>
          <label class="form-check-label" for="schedule-check">일정</label>
        </div>

      </div>

      <hr class="my-4">
      <!--      &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->


      <div id="disease-wrapper">
        <div class="accordion mb-3">
          <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingOne2">
              <button class="accordion-button" type="button">
                🐣 애기
              </button>
            </h2>
            <div id="panelsStayOpen-collapseOne2" class="accordion-collapse collapse show"
                 aria-labelledby="panelsStayOpen-headingOne">
              <div class="accordion-body p-1">
                <ul id="groupPets" class="list-group list-group-flush">
                </ul>
              </div>
            </div>
          </div>
        </div>


        <div class="accordion mb-3">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button">🔖 태그
              </button>
            </h2>
            <div class="accordion-collapse collapse show"
                 aria-labelledby="panelsStayOpen-headingOne">
              <div class="accordion-body p-1">
                <ul id="groupTags" class="list-group list-group-flush">
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion mb-3">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button">
                👥 집사
              </button>
            </h2>
            <div class="accordion-collapse collapse show"
                 aria-labelledby="panelsStayOpen-headingOne">
              <div class="accordion-body p-1">
                <ul id="groupUsers" class="list-group list-group-flush">
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <section id="contents-wrapper">
    <!----------달력---------->
    <div class="col-md-8" id='calendar'>
    </div>
  </section>
</div>


<!-- modal 추가 -->
<div class="modal fade" id="calendarModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">일정을 입력하세요</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="calendar_content" class="col-form-label">일정 내용</label>
          <input type="text" class="form-control" id="calendar_content" name="calendar_content">
          <label for="calendar_start_date" class="col-form-label">시작 날짜</label>
          <input type="date" class="form-control" id="calendar_start_date"
                 name="calendar_start_date">
          <label for="calendar_end_date" class="col-form-label">종료 날짜</label>
          <input type="date" class="form-control" id="calendar_end_date" name="calendar_end_date">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" id="addCalendar">추가</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                id="sprintSettingModalClose">취소
        </button>
      </div>

    </div>
  </div>
</div>

<footer th:replace="~{fragments/footer :: footerFragment}"></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
  // const groupId = [[${groupId}]];
  const groupId = sessionStorage.getItem("groupId");
  let petList;
  let tagList;
  let recordEventList;
  let scheduleEventList;
  let ALLEVENT;
  let SELECTED_EVENT;

  let contentType;

  $(document).ready(function () {
    get_user_list();
    // get_pet_list();
    get_group_tag();
  });

  function selectContentType () {
    const query = 'input[name=contentsType]:checked';
    const selected = document.querySelectorAll(query);

    selected.forEach((el) => {
      contentType.push(el.value);
    })






  }

  axios.defaults.withCredentials = true;

  function date_to_yyyymmdd(date) {
    const year = String(date.getFullYear());
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    return year + month.padStart(2, '0') + day.padStart(2, '0');
  }


  async function getContents(param, callback) {
    let events = [];
    let eventsStructure = await makeEvent(param);
    console.log(eventsStructure)
    setTimeout(() => {
      for (let i = 0; i < petList.length; i++) {
        let id = petList[i]['id'];
        let recordList = ALLEVENT['records'][id];
        const recValues = Object.values(recordList);

        let scheduleList = ALLEVENT['schedules'][id];
        const schValues = Object.values(scheduleList);

        for (let j = 0; j < recValues.length; j++) {
          let value = recValues[j]
          console.log(value)
          events.push(value);
        }

        for (let j = 0; j < schValues.length; j++) {
          let value = schValues[j]
          console.log(value)
          events.push(value);
        }
      }
      setTimeout(() => {
        console.log("events : " + events);
        callback(events);
      })
    })
  }

  async function makeEvent(param) {
    let schedules = {};
    let records = {};
    let storedPetList = await get_pet_list();
    console.log(storedPetList);
    console.log(petList);
    for (let i = 0; i < petList.length; i++) {
      let pet = petList[i];
      let petId = pet['id'];
      let recordsOfPet = await getRecordsOfPet(petId, param);
      let scheduleOfPet = await getSchedulesOfPet(petId, param);
      setTimeout(() => {
        console.log(recordEventList)
        records[petId] = recordEventList;
        schedules[petId] = scheduleEventList;
      })
    }
    let allEvent = {
      "schedules": schedules,
      "records": records
    };
    ALLEVENT = allEvent;
    return allEvent
  }

  async function getRecordsOfPet(petId, param) {
    await axios.get("/api/v1/pets/" + petId + "/records" + param, {}, {
      headers: {},
    }).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        let records = res.data.result;
        let color = randomBrightColor();
        let events = records.map(r => recordToEvent(r, color));
        setTimeout(() => {
          recordEventList = events;
        })
        return events;
      }
    }).catch(err => {
      let res = err.response.data.result;
      let message = res.errorCode + " : " + res.message;
      alert(message);
    });
  }

  async function getSchedulesOfPet(petId, param) {
    await axios.get("/api/v1/pets/" + petId + "/schedules/period" + param, {}, {
      headers: {},
    }).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        let schedules = res.data.result;

        let color = randomBrightColor();
        let events = schedules.map(s => scheduleToEvent(s, color));
        setTimeout(() => {
          scheduleEventList = events;
        })
        return events;
      }
    }).catch(err => {
      let res = err.response.data.result;
      let message = res.errorCode + " : " + res.message;
      alert(message);
    });
  }

  function scheduleToEvent(schedule) {
    let title = schedule['title'];
    let dueDate = schedule['dueDate'];
    var event =
        {
          title: title,
          start: dueDate,
          color: randomBrightColor(),
          textColor: "#333"
        };
    return event;
  }

  function recordToEvent(record, color) {
    let title = record['title'];
    let createdAt = record['createdAt'].substring(0, 10);
    var event =
        {
          title: title,
          start: createdAt,
          color: color,
          textColor: "#333"
        };
    return event;
  }

  // 랜덤 색상
  let randomBrightColor = () => {
    let color_r = Math.floor(Math.random() * 127 + 128).toString(16);
    let color_g = Math.floor(Math.random() * 127 + 128).toString(16);
    let color_b = Math.floor(Math.random() * 127 + 128).toString(16);
    return `#${color_r + color_g + color_b}`;
  }

  async function get_pet_list() {
    await axios.get("/api/v1/groups/" + groupId + "/pets", {}, {
      headers: {
        "Content-Type": `application/json`
      },
    }).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        let pets = res.data.result.pets;
        petList = pets;
        for (let i = 0; i < pets.length; i++) {
          let id = pets[i]['id'];
          let name = pets[i]['name'];
          let temp_html = `
                     <li id="pet-${id}" class="list-group-item">${name}</li>
          `
          $('#groupPets').append(temp_html);
        }
        return pets;
      }
    }).catch(err => {
      let res = err.response.data.result;
      let message = res.errorCode + " : " + res.message;
      alert(message);
    });
  }

  async function get_user_list() {
    await axios.get(`/api/v1/groups/${groupId}/users`, {}, {
      headers: {
        "Content-Type": `application/json`
      },
    }).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        let users = res.data.result.users;

        for (let i = 0; i < users.length; i++) {
          let id = users[i]['id'];
          let roleInGroup = users[i]['roleInGroup'];
          let temp_html = `
                      <li id="user-${id}" class="list-group-item">${roleInGroup}</li>
          `
          $('#groupUsers').append(temp_html);
        }
      }
    }).catch(err => {
      let res = err.response.data.result;
      let message = res.errorCode + " : " + res.message;
      alert(message);
    });
  }

  async function get_group_tag() {
    await axios.get("/api/v1/groups/" + groupId + "/tags", {}, {
      headers: {},
    }).then(res => {
      if (res.data.resultCode == 'SUCCESS') {
        const tags = res.data.result;
        tagList = tags;
        for (let i = 0; i < tags.length; i++) {
          let id = tags[i]['id'];
          let name = tags[i]['name'];

          let temp_html = `
                      <li id="tag-${id}" class="list-group-item">${name}</li>
          `
          $('#groupTags').append(temp_html);
        }
      }
    }).catch(err => {
      let res = err.response.data.result;
      let message = res.errorCode + " : " + res.message;
      alert(message);
    });
  }



  axios.interceptors.request.use(function (config) {
    console.log("인터셉터 시작")
    const accessToken = localStorage.getItem('accessToken');
    if (accessToken) {
      config.headers.Authorization = 'Bearer' + ' ' + accessToken
    } else {
      console.log("headers" + config.headers);
    }
    return config;
  })

</script>

</body>
</html>